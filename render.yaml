services:
  # --------------------------------------------------------------------------------
  # 1. Web Service: Kimi API (Node.js)
  # --------------------------------------------------------------------------------
  - type: web
    name: kimi-api
    env: node
    plan: free
    rootDir: .
    # Build the API package specifically
    buildCommand: corepack enable && corepack prepare pnpm@9.12.3 --activate && pnpm install --filter @app/api... --prod=false && pnpm --filter @app/api build
    # Start the compiled Node.js app
    startCommand: pnpm --filter @app/api start
    envVars:
      - key: NODE_VERSION
        value: 20.11.0
      - key: DATABASE_URL
        sync: false
      - key: CLERK_SECRET_KEY
        sync: false
      - key: CLERK_PUBLISHABLE_KEY
        sync: false
      - key: ADMIN_TOKEN
        generateValue: true

  # --------------------------------------------------------------------------------
  # 2. Cron Job: Judge (Python)
  #    Runs every minute to settle bets.
  # --------------------------------------------------------------------------------
  - type: cron
    name: judge-job
    env: python
    plan: starter
    region: oregon
    rootDir: .
    schedule: "*/1 * * * *"
    buildCommand: pip install -r packages/api/ml/requirements.txt
    startCommand: python packages/api/ml/judge.py
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.9
      - key: DATABASE_URL
        fromService: kimi-api
        name: DATABASE_URL
      - key: PANDA_SCORE_TOKEN
        sync: false
      - key: ADMIN_TOKEN
        fromService: kimi-api
        name: ADMIN_TOKEN
      - key: INTERNAL_API_BASE
        value: http://kimi-api:10000

  # --------------------------------------------------------------------------------
  # 3. Cron Job: Odds Setter (Python)
  #    Runs every 5 minutes to update projections.
  # --------------------------------------------------------------------------------
  - type: cron
    name: odds-setter-job
    env: python
    plan: starter
    region: oregon
    rootDir: .
    schedule: "*/5 * * * *"
    buildCommand: pip install -r packages/api/ml/requirements.txt
    startCommand: python packages/api/ml/odds_setter.py
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.9
      - key: DATABASE_URL
        fromService: kimi-api
        name: DATABASE_URL
      - key: PANDA_SCORE_TOKEN
        sync: false